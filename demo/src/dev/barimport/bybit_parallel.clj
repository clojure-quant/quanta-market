(ns dev.barimport.bybit-parallel
  (:require
   [tick.core :as t]
   [clojure.pprint :refer [print-table]]
   [tech.v3.dataset.print :refer [print-range]]
   [quanta.market.barimport.bybit.import-parallel :as bb]
   [ta.db.bars.protocol :refer [get-bars]]))

(def calendar [:crypto :m])

(def window-feb-29
  {:start (-> "2024-02-29T00:00:00Z" t/instant)
   :end (-> "2024-02-29T00:07:00Z" t/instant)})

(bb/partition-requests calendar window-feb-29)
;; => ()
;; problem: why is there no february 29 in 2024??

(def window
  {:start (-> "2024-05-01T00:00:00Z" t/instant)
   :end (-> "2024-05-02T00:00:00Z" t/instant)})
;; => #'dev.barimport.bybit-parallel/window

(bb/partition-requests calendar window)

;; => ({:start #time/instant "2024-05-01T09:01:00Z",
;;        :end #time/instant "2024-05-01T23:59:59.999999999Z"})

;; problem: why does the time begin at 9:01

(require '[ta.calendar.core :refer [fixed-window]])

(-> (fixed-window calendar window)
    last)
;; => #time/zoned-date-time "2024-05-01T00:01Z[UTC]"

(-> (fixed-window calendar window)
    first)
;; => #time/zoned-date-time "2024-05-01T23:59:59.999999999Z[UTC]"

(-> (fixed-window calendar window)
    count)
;; => 1440

(-> (fixed-window calendar window)
    bb/req-window)

;; => {:start #time/instant "2024-05-01T00:01:00Z", 
;;     :end   #time/instant "2024-05-01T23:59:59.999999999Z"}

(-> (fixed-window calendar window)
    first
    t/instant)

(-> (fixed-window calendar window)
    first)

(bb/parallel-requests
 {:asset "BTCUSDT"
  :calendar calendar}
 window)

(-> (bb/partition-requests calendar window)
    print-table)
;; => nil
; |               :start |                           :end |
; |----------------------+--------------------------------|
; | 2024-05-01T09:01:00Z | 2024-05-01T23:59:59.999999999Z |
; | 2024-05-01T00:01:00Z |           2024-05-01T09:00:00Z |

(def window10
  {:start (-> "2024-05-01T00:00:00Z" t/instant)
   :end (-> "2024-05-10T00:00:00Z" t/instant)})
;; => #'dev.barimport.bybit-parallel/window

(-> (bb/partition-requests calendar window10)
    print-table)
;; => nil
; |               :start |                           :end |
; |----------------------+--------------------------------|
; | 2024-05-09T09:01:00Z | 2024-05-09T23:59:59.999999999Z |
; | 2024-05-08T18:01:00Z |           2024-05-09T09:00:00Z |
; | 2024-05-08T03:01:00Z |           2024-05-08T18:00:00Z |
; | 2024-05-07T12:01:00Z |           2024-05-08T03:00:00Z |
; | 2024-05-06T21:01:00Z |           2024-05-07T12:00:00Z |
; | 2024-05-06T06:01:00Z |           2024-05-06T21:00:00Z |
; | 2024-05-05T15:01:00Z |           2024-05-06T06:00:00Z |
; | 2024-05-05T00:01:00Z |           2024-05-05T15:00:00Z |
; | 2024-05-04T09:01:00Z | 2024-05-04T23:59:59.999999999Z |
; | 2024-05-03T18:01:00Z |           2024-05-04T09:00:00Z |
; | 2024-05-03T03:01:00Z |           2024-05-03T18:00:00Z |
; | 2024-05-02T12:01:00Z |           2024-05-03T03:00:00Z |
; | 2024-05-01T21:01:00Z |           2024-05-02T12:00:00Z |
; | 2024-05-01T06:01:00Z |           2024-05-01T21:00:00Z |

(-> (bb/parallel-requests
     {:asset "BTCUSDT"
      :calendar calendar}
     window10)
    :ds)
;; => _unnamed [12958 6]:
;;    
;;    |                :date |    :open |    :high |     :low |   :close |   :volume |
;;    |----------------------|---------:|---------:|---------:|---------:|----------:|
;;    | 2024-05-01T00:01:00Z | 60745.83 | 60793.52 | 60725.75 | 60765.72 | 10.066118 |
;;    | 2024-05-01T00:02:00Z | 60765.72 | 60765.72 | 60675.95 | 60680.82 | 17.883860 |
;;    | 2024-05-01T00:03:00Z | 60680.82 | 60719.93 | 60677.30 | 60719.93 |  7.574783 |
;;    | 2024-05-01T00:04:00Z | 60719.93 | 60740.69 | 60682.90 | 60687.85 | 14.350392 |
;;    | 2024-05-01T00:05:00Z | 60687.85 | 60740.68 | 60670.98 | 60730.31 | 14.284398 |
;;    | 2024-05-01T00:06:00Z | 60730.31 | 60755.07 | 60698.24 | 60710.29 | 10.978061 |
;;    | 2024-05-01T00:07:00Z | 60710.29 | 60795.42 | 60706.50 | 60787.47 |  7.074850 |
;;    | 2024-05-01T00:08:00Z | 60787.47 | 60816.32 | 60769.58 | 60816.30 |  8.661067 |
;;    | 2024-05-01T00:09:00Z | 60816.30 | 60816.30 | 60764.43 | 60770.70 |  8.340927 |
;;    | 2024-05-01T00:10:00Z | 60770.70 | 60828.28 | 60765.51 | 60826.23 |  7.487682 |
;;    |                  ... |      ... |      ... |      ... |      ... |       ... |
;;    | 2024-05-09T23:49:00Z | 62966.08 | 63079.24 | 62966.08 | 63056.89 | 12.235255 |
;;    | 2024-05-09T23:50:00Z | 63056.89 | 63100.00 | 63049.51 | 63075.00 |  9.105097 |
;;    | 2024-05-09T23:51:00Z | 63075.00 | 63100.19 | 63075.00 | 63094.29 |  7.684912 |
;;    | 2024-05-09T23:52:00Z | 63094.29 | 63099.11 | 63051.11 | 63099.07 |  6.256066 |
;;    | 2024-05-09T23:53:00Z | 63099.07 | 63172.77 | 63091.10 | 63159.85 | 12.117148 |
;;    | 2024-05-09T23:54:00Z | 63159.85 | 63172.23 | 63094.31 | 63098.45 |  8.111909 |
;;    | 2024-05-09T23:55:00Z | 63098.45 | 63123.23 | 63077.74 | 63079.90 |  6.216179 |
;;    | 2024-05-09T23:56:00Z | 63079.90 | 63111.66 | 63079.90 | 63105.88 |  5.409569 |
;;    | 2024-05-09T23:57:00Z | 63105.88 | 63107.10 | 63023.39 | 63023.90 |  7.262002 |
;;    | 2024-05-09T23:58:00Z | 63023.90 | 63074.98 | 63023.90 | 63049.50 |  6.116506 |
;;    | 2024-05-09T23:59:00Z | 63049.50 | 63080.50 | 63049.50 | 63072.51 |  3.137508 |

(def bbi (bb/create-import-bybit-parallel))

(get-bars bbi
          {:asset "BTCUSDT"
           :calendar calendar}
          window10)
;; => _unnamed [12958 6]:
;;    
;;    |                :date |    :open |    :high |     :low |   :close |   :volume |
;;    |----------------------|---------:|---------:|---------:|---------:|----------:|
;;    | 2024-05-01T00:01:00Z | 60745.83 | 60793.52 | 60725.75 | 60765.72 | 10.066118 |
;;    | 2024-05-01T00:02:00Z | 60765.72 | 60765.72 | 60675.95 | 60680.82 | 17.883860 |
;;    | 2024-05-01T00:03:00Z | 60680.82 | 60719.93 | 60677.30 | 60719.93 |  7.574783 |
;;    | 2024-05-01T00:04:00Z | 60719.93 | 60740.69 | 60682.90 | 60687.85 | 14.350392 |
;;    | 2024-05-01T00:05:00Z | 60687.85 | 60740.68 | 60670.98 | 60730.31 | 14.284398 |
;;    | 2024-05-01T00:06:00Z | 60730.31 | 60755.07 | 60698.24 | 60710.29 | 10.978061 |
;;    | 2024-05-01T00:07:00Z | 60710.29 | 60795.42 | 60706.50 | 60787.47 |  7.074850 |
;;    | 2024-05-01T00:08:00Z | 60787.47 | 60816.32 | 60769.58 | 60816.30 |  8.661067 |
;;    | 2024-05-01T00:09:00Z | 60816.30 | 60816.30 | 60764.43 | 60770.70 |  8.340927 |
;;    | 2024-05-01T00:10:00Z | 60770.70 | 60828.28 | 60765.51 | 60826.23 |  7.487682 |
;;    |                  ... |      ... |      ... |      ... |      ... |       ... |
;;    | 2024-05-09T23:49:00Z | 62966.08 | 63079.24 | 62966.08 | 63056.89 | 12.235255 |
;;    | 2024-05-09T23:50:00Z | 63056.89 | 63100.00 | 63049.51 | 63075.00 |  9.105097 |
;;    | 2024-05-09T23:51:00Z | 63075.00 | 63100.19 | 63075.00 | 63094.29 |  7.684912 |
;;    | 2024-05-09T23:52:00Z | 63094.29 | 63099.11 | 63051.11 | 63099.07 |  6.256066 |
;;    | 2024-05-09T23:53:00Z | 63099.07 | 63172.77 | 63091.10 | 63159.85 | 12.117148 |
;;    | 2024-05-09T23:54:00Z | 63159.85 | 63172.23 | 63094.31 | 63098.45 |  8.111909 |
;;    | 2024-05-09T23:55:00Z | 63098.45 | 63123.23 | 63077.74 | 63079.90 |  6.216179 |
;;    | 2024-05-09T23:56:00Z | 63079.90 | 63111.66 | 63079.90 | 63105.88 |  5.409569 |
;;    | 2024-05-09T23:57:00Z | 63105.88 | 63107.10 | 63023.39 | 63023.90 |  7.262002 |
;;    | 2024-05-09T23:58:00Z | 63023.90 | 63074.98 | 63023.90 | 63049.50 |  6.116506 |
;;    | 2024-05-09T23:59:00Z | 63049.50 | 63080.50 | 63049.50 | 63072.51 |  3.137508 |

(get-bars bbi
          {:asset "BTCUSDT"
           :calendar calendar}
          window)
;; => _unnamed [1439 6]:
;;    
;;    |                :date |    :open |    :high |     :low |   :close |   :volume |
;;    |----------------------|---------:|---------:|---------:|---------:|----------:|
;;    | 2024-05-01T00:01:00Z | 60745.83 | 60793.52 | 60725.75 | 60765.72 | 10.066118 |
;;    | 2024-05-01T00:02:00Z | 60765.72 | 60765.72 | 60675.95 | 60680.82 | 17.883860 |
;;    | 2024-05-01T00:03:00Z | 60680.82 | 60719.93 | 60677.30 | 60719.93 |  7.574783 |
;;    | 2024-05-01T00:04:00Z | 60719.93 | 60740.69 | 60682.90 | 60687.85 | 14.350392 |
;;    | 2024-05-01T00:05:00Z | 60687.85 | 60740.68 | 60670.98 | 60730.31 | 14.284398 |
;;    | 2024-05-01T00:06:00Z | 60730.31 | 60755.07 | 60698.24 | 60710.29 | 10.978061 |
;;    | 2024-05-01T00:07:00Z | 60710.29 | 60795.42 | 60706.50 | 60787.47 |  7.074850 |
;;    | 2024-05-01T00:08:00Z | 60787.47 | 60816.32 | 60769.58 | 60816.30 |  8.661067 |
;;    | 2024-05-01T00:09:00Z | 60816.30 | 60816.30 | 60764.43 | 60770.70 |  8.340927 |
;;    | 2024-05-01T00:10:00Z | 60770.70 | 60828.28 | 60765.51 | 60826.23 |  7.487682 |
;;    |                  ... |      ... |      ... |      ... |      ... |       ... |
;;    | 2024-05-01T23:49:00Z | 58495.16 | 58517.13 | 58471.78 | 58495.91 |  7.948641 |
;;    | 2024-05-01T23:50:00Z | 58495.91 | 58513.37 | 58448.28 | 58448.28 | 16.004945 |
;;    | 2024-05-01T23:51:00Z | 58448.28 | 58462.53 | 58387.11 | 58387.12 | 11.897565 |
;;    | 2024-05-01T23:52:00Z | 58387.12 | 58415.23 | 58318.95 | 58333.32 | 13.165554 |
;;    | 2024-05-01T23:53:00Z | 58333.32 | 58334.49 | 58247.98 | 58263.82 | 11.338251 |
;;    | 2024-05-01T23:54:00Z | 58263.82 | 58274.99 | 58230.01 | 58252.37 |  4.555221 |
;;    | 2024-05-01T23:55:00Z | 58252.37 | 58407.80 | 58239.53 | 58345.18 | 38.116847 |
;;    | 2024-05-01T23:56:00Z | 58345.18 | 58393.46 | 58322.39 | 58388.65 | 25.759705 |
;;    | 2024-05-01T23:57:00Z | 58388.65 | 58391.07 | 58320.68 | 58375.97 | 30.993369 |
;;    | 2024-05-01T23:58:00Z | 58375.97 | 58388.01 | 58311.96 | 58315.37 | 15.220031 |
;;    | 2024-05-01T23:59:00Z | 58315.37 | 58389.95 | 58298.51 | 58341.10 | 29.102771 |

(-> (get-bars bbi
              {:asset "BTCUSDT"
               :calendar calendar}
              window)
    (print-range :all))





