(ns dev.barimport.bybit
  (:require
   [missionary.core :as m]
   [tick.core :as t]
   [quanta.market.barimport.bybit.import :refer [create-import-bybit]]
   [ta.db.bars.protocol :refer [get-bars]]))

(def b (create-import-bybit))

(m/?
 (get-bars b
           {:asset "BTCUSDT"
            :calendar [:crypto :m]}
           {:start (-> "2024-02-29T00:00:00Z" t/instant)
            :end (-> "2024-02-29T00:07:00Z" t/instant)}))

;=> _unnamed [8 6]:
;
;|                       :date |    :open |    :high |     :low |   :close |   :volume |
;|-----------------------------|---------:|---------:|---------:|---------:|----------:|
;| 2024-02-28T23:59:59.999999Z | 62439.05 | 62449.99 | 62418.15 | 62424.12 |  9.520713 |
;|        2024-02-29T00:01:00Z | 62424.12 | 62438.70 | 62354.89 | 62394.00 | 30.810483 |
;|        2024-02-29T00:02:00Z | 62394.00 | 62417.47 | 62307.81 | 62307.81 | 32.917325 |
;|        2024-02-29T00:03:00Z | 62307.81 | 62319.50 | 62254.00 | 62311.99 | 23.697547 |
;|        2024-02-29T00:04:00Z | 62311.99 | 62313.47 | 62092.17 | 62092.17 | 25.848561 |
;|        2024-02-29T00:05:00Z | 62092.17 | 62150.40 | 61964.72 | 62150.40 | 58.967209 |
;|        2024-02-29T00:06:00Z | 62150.40 | 62232.40 | 62089.61 | 62193.49 | 47.235039 |
;|        2024-02-29T00:07:00Z | 62193.49 | 62262.80 | 62188.77 | 62262.80 | 22.307600 |

; => because window :start uses bar open time

(get-bars b
          {:asset "BTCUSDT"
           :calendar [:crypto :d]}
          {:start (-> "2024-10-01T00:00:00Z" t/instant)
           :end (-> "2024-10-07T00:00:00Z" t/instant)})
;=> _unnamed [7 6]:
;
;|                       :date |    :open |    :high |     :low |   :close |      :volume |
;|-----------------------------|---------:|---------:|---------:|---------:|-------------:|
;| 2024-09-30T23:59:59.999999Z | 65601.78 | 65634.62 | 62843.01 | 63309.05 | 24387.647721 |
;| 2024-10-01T23:59:59.999999Z | 63309.05 | 64127.88 | 60159.92 | 60812.41 | 34614.967726 |
;| 2024-10-02T23:59:59.999999Z | 60812.41 | 62400.00 | 59974.60 | 60643.07 | 24433.166809 |
;| 2024-10-03T23:59:59.999999Z | 60643.07 | 61485.54 | 59861.28 | 60756.13 | 26729.110701 |
;| 2024-10-04T23:59:59.999999Z | 60756.13 | 62486.35 | 60458.93 | 62090.14 | 23662.217058 |
;| 2024-10-05T23:59:59.999999Z | 62090.14 | 62382.03 | 61680.63 | 62059.37 |  8936.861444 |
;| 2024-10-06T23:59:59.999999Z | 62059.37 | 62983.78 | 61814.96 | 62824.80 |  9037.917928 |

(t/instant)
;; => #time/instant "2024-10-05T19:48:12.209448677Z"

(get-bars b
          {:asset "BTCUSDT"
           :calendar [:crypto :h]}
          {:start (-> "2024-10-05T17:00:00Z" t/instant)
           :end (-> "2024-10-05T19:00:00Z" t/instant)})

;; bybit uses OPEN of CANDLE. 
;; the last candle gets CHANGED until it is closed.

;=> _unnamed [3 6]:
;
;|                :date |    :open |    :high |     :low |   :close |    :volume |
;|----------------------|---------:|---------:|---------:|---------:|-----------:|
;| 2024-10-05T17:00:00Z | 62161.02 | 62184.91 | 61953.41 | 61961.45 | 536.452534 |
;| 2024-10-05T18:00:00Z | 61961.45 | 62040.87 | 61900.78 | 62019.38 | 456.604311 |
;| 2024-10-05T19:00:00Z | 62019.38 | 62056.00 | 61833.42 | 61861.23 | 447.538215 |

; (tc/write-csv! "/clojure-quant/quanta/lib/indicator/test/ta/indicator/csv/BYBIT_SPOT_BTCUSDT_1D.csv")

(get-bars b
          {:asset "BTCUSDT"
           :calendar [:crypto :d]}
          {:start (-> "2024-10-01T23:59:59.999999999Z" t/instant)
           :end (-> "2024-10-04T23:59:59.999999999Z" t/instant)})
;=> _unnamed [4 6]:
;
;|                       :date |    :open |    :high |     :low |   :close |      :volume |
;|-----------------------------|---------:|---------:|---------:|---------:|-------------:|
;| 2024-10-01T23:59:59.999999Z | 63309.05 | 64127.88 | 60159.92 | 60812.41 | 34614.967726 |
;| 2024-10-02T23:59:59.999999Z | 60812.41 | 62400.00 | 59974.60 | 60643.07 | 24433.166809 |
;| 2024-10-03T23:59:59.999999Z | 60643.07 | 61485.54 | 59861.28 | 60756.13 | 26729.110701 |
;| 2024-10-04T23:59:59.999999Z | 60756.13 | 62486.35 | 60458.93 | 62090.14 | 23662.217058 |

(get-bars b
          {:asset "BTCUSDT"
           :calendar [:crypto :d]}
          {:start (-> "2024-10-01T00:00:00Z" t/instant)
           :end (-> "2024-10-04T00:00:00Z" t/instant)})
;=> _unnamed [4 6]:
;
;|                       :date |    :open |    :high |     :low |   :close |      :volume |
;|-----------------------------|---------:|---------:|---------:|---------:|-------------:|
;| 2024-09-30T23:59:59.999999Z | 65601.78 | 65634.62 | 62843.01 | 63309.05 | 24387.647721 |
;| 2024-10-01T23:59:59.999999Z | 63309.05 | 64127.88 | 60159.92 | 60812.41 | 34614.967726 |
;| 2024-10-02T23:59:59.999999Z | 60812.41 | 62400.00 | 59974.60 | 60643.07 | 24433.166809 |
;| 2024-10-03T23:59:59.999999Z | 60643.07 | 61485.54 | 59861.28 | 60756.13 | 26729.110701 |

; => because window uses bar open time instead of close

(get-bars b
          {:asset "BTCUSDT"
           :calendar [:crypto :m]}
          {:start (-> "2024-10-01T00:01:00Z" t/instant)
           :end (-> "2024-10-03T23:59:59.999999999Z" t/instant)})

; with bar close time window
;=> _unnamed [4320 6]:
;
;|                       :date |    :open |    :high |     :low |   :close |   :volume |
;|-----------------------------|---------:|---------:|---------:|---------:|----------:|
;|        2024-10-01T00:01:00Z | 63309.05 | 63422.86 | 63308.65 | 63421.12 | 48.263832 |
;|        2024-10-01T00:02:00Z | 63421.12 | 63488.74 | 63384.91 | 63384.92 | 57.944510 |
;|        2024-10-01T00:03:00Z | 63384.92 | 63384.92 | 63305.08 | 63340.95 | 42.831644 |
;|        2024-10-01T00:04:00Z | 63340.95 | 63344.25 | 63267.30 | 63325.18 | 50.719298 |
;|        2024-10-01T00:05:00Z | 63325.18 | 63358.42 | 63323.60 | 63323.92 | 38.598535 |
;|        2024-10-01T00:06:00Z | 63323.92 | 63376.43 | 63291.53 | 63305.31 | 61.533117 |
;|        2024-10-01T00:07:00Z | 63305.31 | 63354.66 | 63305.31 | 63342.07 | 39.759712 |
;|        2024-10-01T00:08:00Z | 63342.07 | 63377.55 | 63333.14 | 63377.55 | 41.110530 |
;|        2024-10-01T00:09:00Z | 63377.55 | 63385.99 | 63332.79 | 63334.68 | 43.130816 |
;|        2024-10-01T00:10:00Z | 63334.68 | 63344.08 | 63276.38 | 63323.26 | 49.825970 |
;|                         ... |      ... |      ... |      ... |      ... |       ... |
;|        2024-10-03T23:50:00Z | 60790.27 | 60798.06 | 60768.45 | 60784.28 | 18.393332 |
;|        2024-10-03T23:51:00Z | 60784.28 | 60791.67 | 60756.13 | 60756.14 | 19.977261 |
;|        2024-10-03T23:52:00Z | 60756.14 | 60776.13 | 60725.57 | 60730.14 | 28.755261 |
;|        2024-10-03T23:53:00Z | 60730.14 | 60743.11 | 60704.29 | 60714.93 | 37.714317 |
;|        2024-10-03T23:54:00Z | 60714.93 | 60773.46 | 60713.72 | 60773.46 | 22.257980 |
;|        2024-10-03T23:55:00Z | 60773.46 | 60799.88 | 60763.51 | 60768.24 | 25.589040 |
;|        2024-10-03T23:56:00Z | 60768.24 | 60768.24 | 60734.89 | 60744.30 | 15.701340 |
;|        2024-10-03T23:57:00Z | 60744.30 | 60766.72 | 60740.84 | 60757.57 | 19.564767 |
;|        2024-10-03T23:58:00Z | 60757.57 | 60782.20 | 60750.98 | 60777.41 | 13.553497 |
;|        2024-10-03T23:59:00Z | 60777.41 | 60794.40 | 60755.58 | 60757.35 | 23.200737 |
;| 2024-10-03T23:59:59.999999Z | 60757.35 | 60760.68 | 60747.43 | 60756.13 | 13.743697 |
