(ns dev.barimport.bybit
  (:require
   [tick.core :as t]
   [ta.import.provider.bybit.ds :refer [create-import-bybit]]
   [ta.db.bars.protocol :refer [get-bars]]))

(def b (create-import-bybit))

(get-bars b
          {:asset "BTCUSDT"
           :calendar [:crypto :m]}
          {:start (-> "2024-02-29T00:00:00Z" t/instant)
           :end (-> "2024-02-29T00:07:00Z" t/instant)})
;; => _unnamed [8 6]:
;;    
;;    |                :date |    :open |    :high |     :low |   :close |   :volume |
;;    |----------------------|---------:|---------:|---------:|---------:|----------:|
;;    | 2024-02-29T00:00:00Z | 62424.12 | 62438.70 | 62354.89 | 62394.00 | 30.810483 |
;;    | 2024-02-29T00:01:00Z | 62394.00 | 62417.47 | 62307.81 | 62307.81 | 32.917325 |
;;    | 2024-02-29T00:02:00Z | 62307.81 | 62319.50 | 62254.00 | 62311.99 | 23.697547 |
;;    | 2024-02-29T00:03:00Z | 62311.99 | 62313.47 | 62092.17 | 62092.17 | 25.848561 |
;;    | 2024-02-29T00:04:00Z | 62092.17 | 62150.40 | 61964.72 | 62150.40 | 58.967209 |
;;    | 2024-02-29T00:05:00Z | 62150.40 | 62232.40 | 62089.61 | 62193.49 | 47.235039 |
;;    | 2024-02-29T00:06:00Z | 62193.49 | 62262.80 | 62188.77 | 62262.80 | 22.307600 |
;;    | 2024-02-29T00:07:00Z | 62262.80 | 62322.91 | 62262.26 | 62322.91 | 16.503588 |


(get-bars b
          {:asset "BTCUSDT"
           :calendar [:crypto :d]}
          {:start (-> "2024-10-01T00:00:00Z" t/instant)
           :end (-> "2024-10-07T00:00:00Z" t/instant)})
;; => _unnamed [5 6]:
;;    
;;    |                :date |    :open |    :high |     :low |   :close |      :volume |
;;    |----------------------|---------:|---------:|---------:|---------:|-------------:|
;;    | 2024-09-30T23:59:59Z | 63309.05 | 64127.88 | 60159.92 | 60812.41 | 34614.967726 |
;;    | 2024-10-01T23:59:59Z | 60812.41 | 62400.00 | 59974.60 | 60643.07 | 24433.166809 |
;;    | 2024-10-02T23:59:59Z | 60643.07 | 61485.54 | 59861.28 | 60756.13 | 26729.110701 |
;;    | 2024-10-03T23:59:59Z | 60756.13 | 62486.35 | 60458.93 | 62090.14 | 23662.217058 |
;;    | 2024-10-04T23:59:59Z | 62090.14 | 62382.03 | 61680.63 | 61855.02 |  7572.969001 |


(t/instant)
;; => #time/instant "2024-10-05T19:48:12.209448677Z"


(get-bars b
          {:asset "BTCUSDT"
           :calendar [:crypto :h]}
          {:start (-> "2024-10-05T17:00:00Z" t/instant)
           :end (-> "2024-10-06T23:00:00Z" t/instant)})

;; => _unnamed [3 6]:
;;    
;;    |                :date |    :open |    :high |     :low |   :close |    :volume |
;;    |----------------------|---------:|---------:|---------:|---------:|-----------:|
;;    | 2024-10-05T17:00:00Z | 61961.45 | 62040.87 | 61900.78 | 62019.38 | 456.604311 |
;;    | 2024-10-05T18:00:00Z | 62019.38 | 62056.00 | 61833.42 | 61861.23 | 447.538215 |
;;    | 2024-10-05T19:00:00Z | 61861.23 | 61919.93 | 61790.23 | 61808.58 | 363.836550 |


;; => _unnamed [3 6]:
;;    
;;    |                :date |    :open |    :high |     :low |   :close |    :volume |
;;    |----------------------|---------:|---------:|---------:|---------:|-----------:|
;;    | 2024-10-05T17:00:00Z | 61961.45 | 62040.87 | 61900.78 | 62019.38 | 456.604311 |
;;    | 2024-10-05T18:00:00Z | 62019.38 | 62056.00 | 61833.42 | 61861.23 | 447.538215 |
;;    | 2024-10-05T19:00:00Z | 61861.23 | 61919.93 | 61790.23 | 61815.27 | 366.785863 |






; (tc/write-csv! "/clojure-quant/quanta/lib/indicator/test/ta/indicator/csv/BYBIT_SPOT_BTCUSDT_1D.csv")