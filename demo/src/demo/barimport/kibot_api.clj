(ns demo.barimport.kibot-api
  (:require
   [tick.core :as t]
   [missionary.core :as m]
   [tablecloth.api :as tc]
   [ta.db.bars.protocol :as b]
   [quanta.market.barimport.kibot.api :as k]
   [demo.env-bar :refer [secrets]]))

(def kibot (k/create-import-kibot (:kibot secrets)))

kibot

(def w
  {:start (t/instant "2019-12-01T00:00:00Z")
   :end (t/instant "2024-10-19T00:00:00Z")})

;; notes: kibot assets need to be in asset-db first!

(m/?
 (b/get-bars kibot {:asset "EUR/USD"
                    :calendar [:forex :d]}
             w))

;; => kibot-bars [1271 6]:
;;    
;;    |                                    :date |   :open |   :high |    :low |  :close | :volume |
;;    |------------------------------------------|--------:|--------:|--------:|--------:|--------:|
;;    | 2019-12-02T16:30-05:00[America/New_York] | 1.10231 | 1.10901 | 1.10029 | 1.10788 |  137885 |
;;    | 2019-12-03T16:30-05:00[America/New_York] | 1.10789 | 1.10936 | 1.10660 | 1.10813 |  130073 |
;;    | 2019-12-04T16:30-05:00[America/New_York] | 1.10815 | 1.11162 | 1.10666 | 1.10777 |  157470 |
;;    | 2019-12-05T16:30-05:00[America/New_York] | 1.10777 | 1.11081 | 1.10774 | 1.11042 |  116390 |
;;    | 2019-12-06T16:30-05:00[America/New_York] | 1.11042 | 1.11097 | 1.10398 | 1.10601 |  124577 |
;;    | 2019-12-09T16:30-05:00[America/New_York] | 1.10570 | 1.10779 | 1.10534 | 1.10636 |   82865 |
;;    | 2019-12-10T16:30-05:00[America/New_York] | 1.10638 | 1.10978 | 1.10627 | 1.10922 |  120297 |
;;    | 2019-12-11T16:30-05:00[America/New_York] | 1.10921 | 1.11448 | 1.10702 | 1.11294 |  157849 |
;;    | 2019-12-12T16:30-05:00[America/New_York] | 1.11294 | 1.11544 | 1.11031 | 1.11271 |  201109 |
;;    | 2019-12-13T16:30-05:00[America/New_York] | 1.11263 | 1.11996 | 1.11019 | 1.11184 |  280119 |
;;    |                                      ... |     ... |     ... |     ... |     ... |     ... |
;;    | 2024-10-04T16:30-04:00[America/New_York] | 1.10289 | 1.10396 | 1.09512 | 1.09716 |  234351 |
;;    | 2024-10-07T16:30-04:00[America/New_York] | 1.09668 | 1.09868 | 1.09542 | 1.09742 |  224858 |
;;    | 2024-10-08T16:30-04:00[America/New_York] | 1.09700 | 1.09972 | 1.09609 | 1.09800 |  208460 |
;;    | 2024-10-09T16:30-04:00[America/New_York] | 1.09759 | 1.09810 | 1.09361 | 1.09391 |  193187 |
;;    | 2024-10-10T16:30-04:00[America/New_York] | 1.09378 | 1.09549 | 1.08999 | 1.09365 |  249857 |
;;    | 2024-10-11T16:30-04:00[America/New_York] | 1.09336 | 1.09537 | 1.09260 | 1.09358 |  167467 |
;;    | 2024-10-14T16:30-04:00[America/New_York] | 1.09284 | 1.09367 | 1.08881 | 1.09085 |  149732 |
;;    | 2024-10-15T16:30-04:00[America/New_York] | 1.09086 | 1.09168 | 1.08818 | 1.08907 |  173326 |
;;    | 2024-10-16T16:30-04:00[America/New_York] | 1.08887 | 1.09014 | 1.08531 | 1.08619 |  166864 |
;;    | 2024-10-17T16:30-04:00[America/New_York] | 1.08618 | 1.08735 | 1.08110 | 1.08311 |  203582 |
;;    | 2024-10-18T16:30-04:00[America/New_York] | 1.08311 | 1.08694 | 1.08252 | 1.08649 |  154070 |

(m/?
 (b/get-bars kibot {:asset "MSFT"
                    :calendar [:us :d]
                    :import :kibot}
             {:start (t/instant "2019-01-01T00:00:00Z")
              :end (t/instant "2024-10-20T00:00:00Z")}))
;; => kibot-bars [1209 6]:
;;    
;;    |                                    :date |    :open |  :high |     :low |  :close |  :volume |
;;    |------------------------------------------|---------:|-------:|---------:|--------:|---------:|
;;    | 2019-12-31T17:00-05:00[America/New_York] | 156.8500 | 157.77 | 156.4500 | 157.490 | 14933602 |
;;    | 2020-01-02T17:00-05:00[America/New_York] | 158.6500 | 160.73 | 158.3300 | 160.730 | 18355506 |
;;    | 2020-01-03T17:00-05:00[America/New_York] | 158.3249 | 159.95 | 158.0649 | 158.590 | 18201169 |
;;    | 2020-01-06T17:00-05:00[America/New_York] | 157.0800 | 159.10 | 156.5100 | 159.020 | 18266764 |
;;    | 2020-01-07T17:00-05:00[America/New_York] | 159.3200 | 159.67 | 157.3200 | 157.600 | 18804723 |
;;    | 2020-01-08T17:00-05:00[America/New_York] | 158.9300 | 160.80 | 157.9491 | 160.140 | 23421606 |
;;    | 2020-01-09T17:00-05:00[America/New_York] | 161.8150 | 162.22 | 161.0350 | 162.095 | 18896965 |
;;    | 2020-01-10T17:00-05:00[America/New_York] | 162.7400 | 163.22 | 161.1800 | 161.320 | 18128485 |
;;    | 2020-01-13T17:00-05:00[America/New_York] | 161.8900 | 163.31 | 161.2600 | 163.280 | 17015504 |
;;    | 2020-01-14T17:00-05:00[America/New_York] | 163.2200 | 163.60 | 161.7200 | 162.150 | 20089266 |
;;    |                                      ... |      ... |    ... |      ... |     ... |      ... |
;;    | 2024-10-04T17:00-04:00[America/New_York] | 417.8800 | 419.75 | 414.9700 | 416.020 | 11533807 |
;;    | 2024-10-07T17:00-04:00[America/New_York] | 416.0000 | 417.11 | 409.0000 | 409.660 | 14425410 |
;;    | 2024-10-08T17:00-04:00[America/New_York] | 410.9000 | 415.66 | 408.1700 | 414.780 | 12536233 |
;;    | 2024-10-09T17:00-04:00[America/New_York] | 416.0000 | 420.38 | 414.3000 | 417.420 | 10508892 |
;;    | 2024-10-10T17:00-04:00[America/New_York] | 415.2250 | 417.35 | 413.1500 | 415.841 |  9447861 |
;;    | 2024-10-11T17:00-04:00[America/New_York] | 416.1350 | 417.13 | 413.2500 | 416.390 |  9018516 |
;;    | 2024-10-14T17:00-04:00[America/New_York] | 417.6800 | 424.04 | 417.5200 | 419.110 | 11422788 |
;;    | 2024-10-15T17:00-04:00[America/New_York] | 422.2000 | 422.48 | 415.2600 | 418.780 |  9948883 |
;;    | 2024-10-16T17:00-04:00[America/New_York] | 415.1700 | 416.36 | 410.4800 | 416.130 | 10005365 |
;;    | 2024-10-17T17:00-04:00[America/New_York] | 422.3800 | 422.50 | 415.5900 | 416.720 |  8943496 |
;;    | 2024-10-18T17:00-04:00[America/New_York] | 417.1700 | 419.65 | 416.2601 | 418.170 | 10719505 |